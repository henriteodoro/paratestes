<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visualizador de Planilhas (.ods, .xlsx) — V3</title>

<!-- SheetJS: lê .ods/.xlsx no navegador -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  /* ===== base / tipografia ===== */
  :root{
    --azul:#007BFF;
    --amarelo:#FFD700;
    --vermelho:#b22222;
    --cinza:#f7fbff;
    --borda:#e5e7eb;
    --texto:#111;
    --sel-bg: #e6f0ff;
    --warn-bg: #fff4e5;
    --warn-border: #ffd8a8;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100% }
  body{
    font-family: monospace;
    margin:0; padding:0;
    -webkit-font-smoothing:antialiased;
    color:var(--texto);
    background:#fff;
  }

  /* ===== header (estética MAC) ===== */
  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:var(--azul);
    color:#fff;
    padding:10px 14px;
    gap:12px;
    position:sticky; top:0; z-index:999;
  }
  .menu-left,.menu-right{ display:flex; gap:8px; align-items:center; }
  .icon-btn{
    background:none; border:none; color:#fff;
    font-size:18px; cursor:pointer;
    padding:6px 8px; border-radius:6px; user-select:none;
    width:32px; height:32px; display:flex; align-items:center; justify-content:center;
  }
  .icon-btn img{ width:20px; height:20px; filter:brightness(0) invert(1); }

  /* dropdowns */
  .menu-dropdown{ position:relative; }
  .menu-dropdown.left .menu-dropdown-content{ left:0; right:auto; }
  .menu-dropdown-content{
    display:none; position:absolute; top:calc(100% + 6px);
    right:0; left:auto; background:#fff; color:#111; border-radius:6px;
    box-shadow:0 6px 18px rgba(0,0,0,.15);
    min-width:220px; overflow:auto; z-index:1200; padding:6px 0;
  }
  .menu-dropdown-content a{
    display:block; padding:8px 12px; color:#111; text-decoration:none;
  }
  .menu-dropdown-content a:hover{ background:#f2f2f2; }

  /* ===== título (sem setas) ===== */
  .titulo-nav{
    display:flex; justify-content:center; align-items:center;
    gap:16px; margin:14px 10px 8px; text-align:center;
  }
  .titulo-nav h1{ margin:0; font-size:18px; color:#111; }

  /* ===== layout geral ===== */
  .wrap{ max-width:1100px; margin:0 auto; padding:8px 14px 28px; }

  /* ===== uploader (drag & drop) ===== */
  #uploader{ margin-top:8px; }
  .dropzone{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:6px; width:100%;
    border:2px dashed var(--azul);
    border-radius:12px; padding:28px; text-align:center;
    background:var(--cinza); color:#0b305a;
    cursor:pointer; user-select:none;
    transition:.15s ease;
    min-height:160px;
  }
  .dropzone .title{ font-weight:700; margin-bottom:6px; font-size:14px; }
  .dropzone .hint{ font-size:12px; opacity:.8; }
  .dropzone.dragover{ background:#eef6ff; border-style:solid; transform:scale(1.01); }
  #file-input{ position:absolute; left:-9999px; width:1px; height:1px; opacity:0; }

  /* ===== viewer ===== */
  #viewer{ display:none; }
  .file-info{
    margin:20px 0 10px 0; padding:10px 0; border-bottom:1px solid var(--borda);
  }
  .file-info span{ font-size:12px; opacity:.85; }
  .file-info strong{ font-size:13px; }

  .actions-top{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:10px 0;
    justify-content:space-between;
  }
  .left-actions{ display:flex; gap:8px; align-items:center; }
  .right-actions{ 
    display:flex; flex-direction:column; align-items:flex-end; gap:6px; 
    margin-top:10px;
  }

  .tabs{
    display:flex; gap:6px; flex-wrap:wrap; margin:10px 0 10px;
  }
  .tab-btn{
    padding:6px 10px; border:1px solid var(--borda); border-radius:6px;
    background:#fff; cursor:pointer; font-family:monospace; font-size:12px;
  }
  .tab-btn.active{ background:#e8f2ff; border-color:#cfe2ff; color:#0b305a; }

  .sheets{
    width:100%; overflow:auto; border:1px solid var(--borda);
    border-radius:8px; background:#fff;
  }
  .sheet{ display:none; padding:12px; }
  .sheet.active{ display:block; }
  .sheet table{
    width:100%; border-collapse:collapse; table-layout:auto; font-size:12px;
  }
  .sheet th,.sheet td{
    border:1px solid #ddd; padding:6px 8px; vertical-align:top; word-break:break-word;
  }
  .sheet thead th{ background:#f9fafb; font-weight:700; }
  .sheet tbody tr:nth-child(even){ background:#fafafa; }

  .viewer-footer{
    margin-top:10px; display:flex; flex-wrap:wrap;
    gap:10px; align-items:center; justify-content:space-between;
  }
  .status{ font-size:12px; color:#333; }
  .btn{
    border:1px solid var(--borda); background:#fff; cursor:pointer;
    padding:8px 12px; border-radius:6px; font-family:monospace; font-size:12px;
    transition:all 0.2s ease;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 2px 4px rgba(0,0,0,0.1); }
  .btn-primaria{ background:#e8f2ff; border-color:#cfe2ff; color:#0b305a; }
  .btn-perigo{ background:var(--vermelho); color:#fff; border:none; }

  /* aviso/Toast */
  #copy-notice{
    position: fixed; right: 18px; bottom: 18px;
    background: rgba(0,0,0,0.84); color: white;
    padding: 9px 13px; border-radius: 8px;
    display: none; z-index: 2000; font-size:12px;
  }

  /* painel de substituições - novo visual com caixinhas */
  .subst-panel{ 
    min-width:520px; 
    max-height: 80vh; /* Altura máxima do painel */
    overflow-y: auto; /* Rolagem interna */
  }
  .subst-header{ 
    padding:8px 12px; 
    border-bottom:1px solid #eee; 
    background:#fafafa; 
    font-weight:700; 
    position: sticky;
    top: 0;
    background: #fafafa;
    z-index: 10;
  }
  .subst-toolbar{ 
    display:flex; 
    flex-direction: column;
    gap:12px;
    margin:8px 0; 
    flex-wrap:wrap;
    padding:12px; 
    background:#f8f9fa; 
    border-radius:8px; 
    border:1px solid var(--borda);
  }
  .subst-toolbar-top {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .subst-toolbar-bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
  }
  .subst-toolbar-left {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .subst-toolbar-right {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .subst-toolbar .subst-sets{ 
    width: 100%;
    padding:6px 8px; 
    border-radius:6px; 
    border:1px solid #eee; 
    background:#fff; 
    font-family:monospace; 
    font-size:12px; 
  }
  .subst-toolbar .btn, .subst-toolbar .add-mapping-btn{ white-space:nowrap; font-family:monospace; font-size:12px; }

  .subst-main{ display:flex; gap:12px; padding:10px; }
  .subst-left{ flex:1; }
  .subst-right{ display:none; }

  /* mapping list (caixinhas) COM ROLAGEM INTERNA */
  .subst-list{ 
    display:flex; 
    flex-direction:column; 
    gap:8px; 
    margin-top:12px; 
    max-height: 300px; /* Altura máxima da lista */
    overflow-y: auto;  /* Rolagem interna */
    padding-right: 4px; /* Espaço para a barra de rolagem */
    position: relative;
  }
  .subst-list.readonly-mode::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(232, 242, 255, 0.4);
    z-index: 1;
    pointer-events: none;
    border-radius: 6px;
  }
  .map-row{ 
    display:flex; 
    gap:8px; 
    align-items:center;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    background: #fff;
    position: relative;
    z-index: 2;
  }
  .map-key, .map-val{ 
    flex:1; 
    padding:8px 10px; 
    border-radius:8px; 
    border:1px solid #e6e6e6; 
    font-family:monospace; 
    font-size:13px; 
    background:#fff; 
  }
  .map-key:disabled, .map-val:disabled {
    background: #f8f9fa;
    color: #6b7280;
    cursor: not-allowed;
  }
  .map-key{ max-width:220px; }
  .map-arrow{ width:36px; height:28px; display:flex; align-items:center; justify-content:center; }
  .map-del{ background:none; border:none; padding:6px; cursor:pointer; font-size:14px; border-radius:6px; font-family:monospace; }
  .map-del:hover{ background:#ffecec; }
  
  /* Botão de adicionar - NOVO ESTILO (igual ao do pedido) */
  .add-mapping-btn { 
    display: none; /* Inicialmente escondido */
    align-items: center; 
    justify-content: center; 
    gap: 6px; 
    margin-top: 8px; 
    padding: 8px 12px; 
    background: #f7fbff; 
    border: 1px dashed #b8d4ff; 
    border-radius: 6px; 
    cursor: pointer; 
    font-size: 13px; 
    color: #007BFF; 
    font-family: monospace;
    transition: all 0.2s ease;
    width: 100%;
    box-sizing: border-box;
    position: relative;
    z-index: 2;
  }
  .add-mapping-btn:hover { 
    background: #eef6ff; 
    border-color: #007BFF;
    border-style: solid;
  }

  .edit-mode-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    color: #6b7280;
    font-family: monospace;
    transition: all 0.2s ease;
  }
  .edit-mode-btn:hover {
    background: #e5e7eb;
    border-color: #d1d5db;
  }

  .preview-btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; border:1px solid var(--borda); background:#fff; cursor:pointer; }
  .preview-count{ margin-top:8px; font-size:13px; font-weight:700; color:#111; }

  /* seleção de células */
  td.cell-selected{ background:var(--sel-bg) !important; outline:2px solid rgba(0,123,255,0.12); }

  /* linha separadora */
  .separator{
    margin:15px 0; border-top:1px solid var(--borda); padding-top:15px;
  }
  .separator-title{
    font-weight:700; margin-bottom:10px; font-size:13px; color:#333;
  }

  /* botões horizontais */
  .horizontal-buttons{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    justify-content: space-between;
    width: 100%;
  }

  /* Botão ver mais */
  .show-more-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    margin-top: 8px;
    padding: 6px 10px;
    background: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    color: #6b7280;
    font-family: monospace;
    transition: all 0.2s ease;
    width: 100%;
    box-sizing: border-box;
  }
  .show-more-btn:hover {
    background: #e5e7eb;
    border-color: #d1d5db;
  }

  /* ===== impressão ===== */
  @media print{
    header, .menu-dropdown-content, #uploader, #copy-notice, .viewer-footer .btn { display:none !important; }
    html, body { background:#fff; height:auto !important; overflow:visible !important; }
    .wrap{ padding:0; max-width:none; page-break-after:avoid; break-after:avoid-page; }
    .titulo-nav{ margin:0 0 6px 0; }
    .sheet{ padding:0; }
    .sheets{ border:none; }
    .sheet table{ font-size:10px; page-break-inside:auto; }
    .sheet tr, .sheet td, .sheet th{ page-break-inside:avoid; break-inside:avoid; }
    @page{ size:A4 portrait; margin:10mm; }
  }

  /* subst inline warning */
  .subst-warning{ display:none; padding:8px 10px; border-radius:6px; background:var(--warn-bg); border:1px solid var(--warn-border); color:#7a4e00; font-size:13px; margin-top:8px; }
  .subst-inline{ display:none; margin-top:8px; gap:8px; align-items:center; }
  .subst-inline input{ padding:6px 8px; border-radius:6px; border:1px solid #ddd; font-family:monospace; font-size:12px; }

  /* modal para salvar como */
  .modal-overlay{
    position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5);
    display:none; align-items:center; justify-content:center; z-index:3000;
  }
  .modal-content{
    background:#fff; padding:20px; border-radius:8px; min-width:300px; max-width:500px;
    box-shadow:0 10px 25px rgba(0,0,0,0.2);
  }
  .modal-header{ font-weight:700; margin-bottom:15px; font-family:monospace; }
  .modal-body{ margin-bottom:15px; }
  .modal-footer{ display:flex; gap:8px; justify-content:flex-end; }

  /* Aviso quando não há arquivo carregado */
  .no-file-warning {
    padding: 12px;
    background: #fff4e5;
    border: 1px solid #ffd8a8;
    border-radius: 6px;
    color: #7a4e00;
    font-size: 13px;
    text-align: center;
    margin: 10px 0;
  }
</style>
</head>
<body>

<header>
  <!-- ESQUERDA -->
  <div class="menu-left">
    <div class="menu-dropdown left">
      <button class="icon-btn" title="Menu (☰)" onclick="toggleMenu('dropdown-menu')">
        <img src="icones/menu-hamburger.png" alt="Menu">
      </button>
      <div class="menu-dropdown-content" id="dropdown-menu">
        <a href="#" onclick="showToast('Página 1 (em breve)');return false;">Página 1 (em breve)</a>
        <a href="#" onclick="showToast('Página 2 (em breve)');return false;">Página 2 (em breve)</a>
        <a href="#" onclick="showToast('Página 3 (em breve)');return false;">Página 3 (em breve)</a>
      </div>
    </div>
    <button class="icon-btn" title="Fechar (❌)" onclick="fecharPagina()">
      <img src="icones/fechar.png" alt="Fechar">
    </button>
    <button class="icon-btn" title="Menu inicial (🏠)" onclick="voltarMenu()">
      <img src="icones/home.png" alt="Início">
    </button>
  </div>

  <!-- DIREITA -->
  <div class="menu-right">
    <div class="menu-dropdown">
      <button class="icon-btn" id="btn-salvar" title="Salvar (💾)" onclick="toggleMenu('dropdown-save')">
        <img src="icones/salvar.png" alt="Salvar">
      </button>
      <div class="menu-dropdown-content" id="dropdown-save" aria-labelledby="btn-salvar">
        <a href="#" onclick="exportarXLSX();fecharTodosMenus();return false;">Salvar como XLSX</a>
        <a href="#" onclick="exportarCSVAtivo();fecharTodosMenus();return false;">Salvar CSV (aba ativa)</a>
        <a href="#" onclick="exportarJSON();fecharTodosMenus();return false;">Salvar como JSON</a>
      </div>
    </div>

    <button class="icon-btn" id="btn-print" title="Imprimir (🖨️)" onclick="imprimirAtual()">
      <img src="icones/imprimir.png" alt="Imprimir">
    </button>
    <button class="icon-btn" id="btn-copy" title="Copiar (📋)" onclick="copiarTabelaAtiva()">
      <img src="icones/copiar.png" alt="Copiar">
    </button>

    <!-- Substituições: abre painel com dicionário editável, aplicar / restaurar -->
    <div class="menu-dropdown">
      <button class="icon-btn" id="btn-subst" title="Substituições (abrir painel)" onclick="toggleSubstMenu(event)">
        <img src="icones/substituicoes.png" alt="Substituições">
      </button>

      <!-- pequeno menu mostrado quando NÃO há arquivo carregado -->
      <div class="menu-dropdown-content" id="dropdown-subst-short" aria-labelledby="btn-subst" style="min-width:180px; display:none;">
        <a href="#" onclick="openAnotherFile(); fecharTodosMenus(); return false;">Carregar planilha</a>
        <a href="#" onclick="showToast('Substituições: carregue uma planilha primeiro'); fecharTodosMenus(); return false;">Como usar</a>
      </div>

      <!-- painel completo (aberto apenas quando há arquivo) -->
      <div class="menu-dropdown-content" id="dropdown-subst" aria-labelledby="btn-subst" style="min-width:520px;padding:0; max-height: 80vh; overflow-y: auto;">
        <div class="subst-panel" style="padding:0; min-width:520px;">
          <div class="subst-header">Painel de Substituições</div>
          <div style="padding:10px;">
            <div style="display:flex;gap:12px;align-items:flex-start;justify-content:space-between;">
              <div class="subst-left">
                <div class="subst-toolbar">
                  <div class="subst-toolbar-top">
                    <select id="subst-sets" class="subst-sets"></select>
                    <div class="subst-toolbar-left">
                      <button class="btn" id="btn-new" onclick="showNewModal()">Novo</button>
                      <button class="btn" id="btn-save-as" onclick="showSaveAsModal()">Salvar como...</button>
                      <button class="btn" id="btn-delete-set" onclick="showDeleteModal()">Excluir</button>
                    </div>
                  </div>
                  <div class="subst-toolbar-bottom">
                    <div></div> <!-- Espaço vazio para alinhar o botão de editar à direita -->
                    <div class="subst-toolbar-right">
                      <button class="edit-mode-btn" id="btn-edit-set" title="Editar conjunto">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M12 3.99997H6C4.89543 3.99997 4 4.8954 4 5.99997V18C4 19.1045 4.89543 20 6 20H18C19.1046 20 20 19.1045 20 18V12M18.4142 8.41417L19.5 7.32842C20.281 6.54737 20.281 5.28104 19.5 4.5C18.7189 3.71895 17.4526 3.71895 16.6715 4.50001L15.5858 5.58575M18.4142 8.41417L12.3779 14.4505C12.0987 14.7297 11.7431 14.9201 11.356 14.9975L8.41422 15.5858L9.00257 12.6441C9.08001 12.2569 9.27032 11.9013 9.54951 11.6221L15.5858 5.58575M18.4142 8.41417L15.5858 5.58575" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Aviso quando não há arquivo -->
                <div id="no-file-warning" class="no-file-warning" style="display:none;">
                  Carregue uma planilha para usar as substituições.
                </div>

                <!-- aviso inline (não pop-up) -->
                <div id="subst-warning" class="subst-warning" role="status" aria-live="polite"></div>

                <!-- agora usamos caixinhas (linhas) ao invés de textarea -->
                <div class="subst-list" id="subst-list" aria-live="polite"></div>

                <!-- Botão de adicionar (aparece apenas se não for o conjunto Padrão e estiver em modo de edição) -->
                <button class="add-mapping-btn" id="btn-add-mapping" title="Adicionar mapeamento">Adicionar</button>

                <div class="separator">
                  <div class="horizontal-buttons">
                    <button class="btn btn-primaria" id="btn-apply-subst" onclick="applySubstitutionsFromUI()">Aplicar substituições</button>
                    <button class="btn" id="btn-restore-original" onclick="restoreOriginalsFromUI()">Restaurar original</button>
                    <button class="btn" id="btn-sort-subst" title="Ordenar A–Z (1ª coluna)" onclick="toggleSortSheetAtiva()">Ordenar A–Z (1ª coluna)</button>
                  </div>
                </div>

              </div>

              <div class="subst-right">
                <!-- Esta seção foi removida conforme solicitado -->
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>
</header>

<!-- Título -->
<div class="titulo-nav">
  <h1 id="titulo">Visualizador de Planilhas (.ods, .xlsx)</h1>
</div>

<div class="wrap">
  <!-- ===== Uploader ===== -->
  <section id="uploader" aria-label="Carregar planilha">
    <input id="file-input" type="file" accept=".ods,.xlsx,.xls,.csv" />
    <label class="dropzone" id="dropzone" for="file-input">
      <div class="title">Arraste e solte seu arquivo .ods / .xlsx aqui</div>
      <div class="hint">ou clique nesta área para selecionar do computador</div>
    </label>
  </section>

  <!-- ===== Viewer ===== -->
  <section id="viewer" aria-label="Visualização da planilha">
    <!-- Informações do arquivo movidas para baixo -->
    <div class="file-info">
      <span>Arquivo: <strong id="nome-arquivo">—</strong></span>
    </div>

    <div class="actions-top">
      <div class="left-actions">
        <button class="btn" id="btn-open-other" onclick="openAnotherFile()" title="Abrir outro arquivo">Abrir outro arquivo</button>
      </div>
      <div class="right-actions" id="viewer-controls-right">
        <div id="right-selection" style="font-size:12px;color:#333;">Selecionadas: <strong id="selection-count">0</strong></div>
      </div>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="sheets" id="sheets"></div>

    <div class="viewer-footer">
      <div class="status" id="status">Pronto.</div>
      <div id="viewer-footer-actions" style="display:flex;gap:8px;align-items:center;">
        <!-- mantemos apenas status / pequenos controles aqui; exportação no menu salvar -->
      </div>
    </div>
  </section>
</div>

<!-- Modal para Novo -->
<div class="modal-overlay" id="newModal">
  <div class="modal-content">
    <div class="modal-header">Novo Conjunto</div>
    <div class="modal-body">
      <input type="text" id="newName" placeholder="Nome do conjunto" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;" />
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="confirmNew()">Confirmar</button>
      <button class="btn" onclick="closeNewModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal para Salvar Como -->
<div class="modal-overlay" id="saveAsModal">
  <div class="modal-content">
    <div class="modal-header">Salvar conjunto como</div>
    <div class="modal-body">
      <input type="text" id="saveAsName" placeholder="Nome do conjunto" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:monospace;" />
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="confirmSaveAs()">Confirmar</button>
      <button class="btn" onclick="closeSaveAsModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal para Excluir -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">Confirmar exclusão</div>
    <div class="modal-body">
      Tem certeza que deseja excluir o conjunto "<span id="delete-set-name"></span>"?
    </div>
    <div class="modal-footer">
      <button class="btn btn-perigo" onclick="confirmDelete()">Excluir</button>
      <button class="btn" onclick="closeDeleteModal()">Cancelar</button>
    </div>
  </div>
</div>

<div id="copy-notice">Copiado!</div>

<script>
// O JavaScript permanece exatamente o mesmo da versão anterior
/* ========= helpers visuais / toasts ========= */
let previousStatus = 'Pronto.'; // Para armazenar o status anterior à seleção

function showToast(msg){
  const el = document.getElementById('copy-notice');
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>{ el.style.display='none'; }, 1700);
}
function toggleMenu(id){
  document.querySelectorAll('.menu-dropdown-content').forEach(el=>{
    if(el.id !== id){ el.style.display='none'; el.style.opacity=0; }
  });
  const el = document.getElementById(id);
  if(!el) return;
  if(el.style.display==='block'){ el.style.opacity=0; setTimeout(()=>el.style.display='none',180); }
  else{ el.style.display='block'; el.style.opacity=0; setTimeout(()=>el.style.opacity=1,10); }
}
function fecharTodosMenus(){
  document.querySelectorAll('.menu-dropdown-content').forEach(el=>{ el.style.display='none'; el.style.opacity=0; });
}
document.addEventListener('click',(ev)=>{
  if(!ev.target.closest('.menu-dropdown')) fecharTodosMenus();
});
function fecharPagina(){ if(confirm('Fechar a página? (pode não funcionar em todos navegadores)')){ try{ window.close(); }catch(e){} } }
function voltarMenu(){ showToast('Voltar ao menu (configure o redirecionamento).'); }

/* ========= estado ========= */
let currentWB = null;         // workbook carregado
let currentFileName = null;   // nome do arquivo
let activeSheetName = null;   // aba ativa
let originalSheetsAOA = {};    // snapshot AOA por aba (para restaurar)
let sortedSheets = new Set();  // abas atualmente ordenadas

// substituições - agora armazenamos conjuntos como { nome: [ {k,v}, ... ] }
let substitutionDict = {};              // mapa internalizado (chave normalizada -> valor)
let substitutionAppliedSheets = new Set(); // quais abas já receberam substituições
const SUBST_LS_KEY = 'viewer_substitutions_v3';

// seleção de células
let isSelecting = false;
let selectStart = null;
let selectedCells = new Set();

// Controle de exibição das listas
let expandedSets = {};

// Modo de edição
let isEditMode = false;

/* ========= elementos ========= */
const uploader = document.getElementById('uploader');
const viewer   = document.getElementById('viewer');
const dropzone = document.getElementById('dropzone');
const fileInput= document.getElementById('file-input');
const tabs     = document.getElementById('tabs');
const sheets   = document.getElementById('sheets');
const statusEl = document.getElementById('status');
const selCountEl = document.getElementById('selection-count');
const viewerControlsRight = document.getElementById('viewer-controls-right');

/* ========= drag & drop / seleção ========= */
dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.classList.add('dragover'); });
dropzone.addEventListener('dragleave', ()=> dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop', (e)=>{
  e.preventDefault(); dropzone.classList.remove('dragover');
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f) processFile(f);
});
fileInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(f) processFile(f);
});

/* ========= processamento ========= */
function processFile(file){
  statusEl.textContent = 'Lendo arquivo...';
  previousStatus = 'Lendo arquivo...';
  originalSheetsAOA = {};
  sortedSheets = new Set();
  substitutionAppliedSheets = new Set();
  currentFileName = file.name;
  document.getElementById('titulo').textContent = `Visualizador de Planilhas — ${currentFileName}`;
  document.getElementById('nome-arquivo').textContent = currentFileName;

  const reader = new FileReader();
  reader.onload = function(evt){
    try{
      const data = new Uint8Array(evt.target.result);
      const wb = XLSX.read(data, { type:'array' }); // suporta .ods/.xlsx
      currentWB = wb;
      renderWorkbook(wb);
      uploader.style.display = 'none';
      viewer.style.display   = 'block';
      statusEl.textContent   = `Carregado: ${file.name} (${wb.SheetNames.length} aba${wb.SheetNames.length>1?'s':''})`;
      previousStatus = statusEl.textContent;
    }catch(err){
      console.error(err);
      statusEl.textContent = 'Erro ao ler o arquivo.';
      previousStatus = statusEl.textContent;
      showToast('Não consegui abrir esse arquivo.');
    }
  };
  reader.onerror = function(){ 
    statusEl.textContent = 'Falha na leitura do arquivo.'; 
    previousStatus = statusEl.textContent;
    showToast('Falha na leitura do arquivo.'); 
  };
  reader.readAsArrayBuffer(file);
}

function renderWorkbook(wb){
  tabs.innerHTML = '';
  sheets.innerHTML = '';
  sheets.style.display = 'block';
  tabs.style.display   = 'flex';

  wb.SheetNames.forEach((name, idx)=>{
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.textContent = name || `Aba ${idx+1}`;
    btn.addEventListener('click', ()=> setActiveSheet(name));
    tabs.appendChild(btn);

    const ws = wb.Sheets[name];
    const __aoa = XLSX.utils.sheet_to_json(ws, { header:1 });
    originalSheetsAOA[name] = __aoa.map(r => Array.isArray(r) ? r.slice() : []);
    const html = XLSX.utils.sheet_to_html(ws, { id:`sheet-${idx}`, header:'', footer:'' });

    const pane = document.createElement('div');
    pane.className = 'sheet';
    pane.dataset.name = name;
    pane.innerHTML = html; // a <table> vem pronta
    sheets.appendChild(pane);

    // depois de inserir, vincula interação na tabela
    bindTableInteractions(pane);
  });

  setActiveSheet(wb.SheetNames[0]);
}

function setActiveSheet(name){
  activeSheetName = name;
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.classList.toggle('active', btn.textContent === name);
  });
  document.querySelectorAll('.sheet').forEach(p=>{
    p.classList.toggle('active', p.dataset.name === name);
  });
  clearSelection();
  updateSubstUIState();
}

/* ========= exportações ========= */
function exportarXLSX(){
  if(!currentWB){ showToast('Nada para salvar.'); return; }
  const nome = (currentFileName || 'planilha') + '.xlsx';
  XLSX.writeFile(currentWB, nome);
  showToast('Baixando XLSX…');
}
function exportarCSVAtivo(){
  if(!currentWB || !activeSheetName){ showToast('Nenhuma aba ativa.'); return; }
  const ws = currentWB.Sheets[activeSheetName];
  const csv = XLSX.utils.sheet_to_csv(ws);
  downloadText(csv, sanitizeFileName(activeSheetName)+'.csv', 'text/csv;charset=utf-8;');
  showToast('CSV gerado.');
}
function exportarJSON(){
  if(!currentWB){ showToast('Nada para salvar.'); return; }
  const out = {};
  currentWB.SheetNames.forEach(name=>{
    const ws = currentWB.Sheets[name];
    out[name] = XLSX.utils.sheet_to_json(ws, { defval:null });
  });
  downloadText(JSON.stringify(out,null,2), (currentFileName||'planilha')+'.json', 'application/json;charset=utf-8;');
  showToast('JSON gerado.');
}
function downloadText(content, filename, type){
  const blob = new Blob([content], { type });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function sanitizeFileName(s){ return (s||'').toString().replace(/[\\/:*?"<>|]+/g,'_').trim() || 'aba'; }

/* ========= copiar ========= */
function copiarTabelaAtiva(){
  if(!activeSheetName || !currentWB){ showToast('Nada para copiar.'); return; }
  
  // Se há células selecionadas, copia apenas a seleção
  if (selectedCells.size > 0) {
    copiarSelecao();
  } else {
    // Caso contrário, copia a tabela inteira
    const ws = currentWB.Sheets[activeSheetName];
    const tsv = XLSX.utils.sheet_to_csv(ws, { FS:"\t" });
    navigator.clipboard.writeText(tsv).then(()=>showToast('Copiado!')).catch(()=>showToast('Não foi possível copiar.'));
  }
}

function copiarSelecao() {
  const activePane = document.querySelector('.sheet.active');
  if (!activePane) return;
  
  const table = activePane.querySelector('table');
  if (!table) return;
  
  // Encontrar os limites da seleção
  let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;
  selectedCells.forEach(cellKey => {
    const [r, c] = cellKey.split('|').map(Number);
    if (r < minR) minR = r;
    if (r > maxR) maxR = r;
    if (c < minC) minC = c;
    if (c > maxC) maxC = c;
  });
  
  // Criar uma matriz para a seleção
  const data = [];
  for (let r = minR; r <= maxR; r++) {
    const row = [];
    for (let c = minC; c <= maxC; c++) {
      const cell = table.rows[r]?.cells[c];
      const text = cell ? cell.textContent : '';
      row.push(text);
    }
    data.push(row);
  }
  
  // Converter para TSV
  const tsv = data.map(row => row.join('\t')).join('\n');
  
  navigator.clipboard.writeText(tsv).then(() => {
    showToast('Seleção copiada!');
  }).catch(() => {
    showToast('Não foi possível copiar a seleção.');
  });
}

/* ========= imprimir ========= */
function hasConteudoImprimivel(){
  if(!currentWB) return false;
  const ativa = document.querySelector('.sheet.active table');
  if(!ativa) return false;
  return ativa.querySelector('td,th') !== null;
}
function imprimirAtual(){
  if(!hasConteudoImprimivel()){ showToast('Nada para imprimir.'); return; }
  window.print();
}

/* ========= reset (fazer com outro) ========= */
function resetViewer(){
  tabs.innerHTML = '';
  sheets.innerHTML = '';
  currentWB = null; activeSheetName = null;
  originalSheetsAOA = {}; sortedSheets = new Set(); substitutionAppliedSheets = new Set();
  document.getElementById('nome-arquivo').textContent = '—';
  document.getElementById('titulo').textContent = 'Visualizador de Planilhas (.ods, .xlsx)';
  statusEl.textContent = 'Pronto.';
  previousStatus = 'Pronto.';
  try{ fileInput.value = ''; }catch(e){}
  viewer.style.display = 'none';
  uploader.style.display = 'block';
}

function openAnotherFile(){
  try{ fileInput.value = ''; }catch(e){}
  fileInput.click();
}

/* ========= acessibilidade/UX ========= */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){ 
    fecharTodosMenus(); 
    clearSelection(); // ESC agora limpa a seleção
  }
});

// Permitir deseleção ao clicar fora da planilha
document.addEventListener('mousedown', (e)=>{
  if(!e.target.closest('.sheet') && !e.target.closest('.menu-dropdown-content')) {
    clearSelection();
  }
});

/* ========= ORDENAR A–Z (1ª coluna) ========= */
function toggleSortSheetAtiva(){
  if(!currentWB || !activeSheetName){ showToast('Nenhuma aba ativa.'); return; }

  // Usa a planilha atual (com substituições aplicadas) como base
  const ws0 = currentWB.Sheets[activeSheetName];
  const aoa0 = XLSX.utils.sheet_to_json(ws0, { header:1 });
  
  const isSorted = sortedSheets.has(activeSheetName);

  let novoWS;
  if(isSorted){
    // Se já está ordenado, restaura do original
    const base = originalSheetsAOA[activeSheetName].map(r => r.slice());
    novoWS = XLSX.utils.aoa_to_sheet(base);
    sortedSheets.delete(activeSheetName);
    statusEl.textContent = `Ordem restaurada A–Z na aba "${activeSheetName}"`;
    previousStatus = statusEl.textContent;
    showToast('Ordem original restaurada.');
  }else{
    // Ordena a planilha atual
    if(aoa0.length <= 1){ showToast('Nada para ordenar.'); return; }
    const header = aoa0[0].slice();
    const linhas = aoa0.slice(1).map(r => r.slice());

    const collator = new Intl.Collator('pt', { sensitivity:'base', numeric:true });
    const norm = v => (v ?? '').toString().trim();
    linhas.sort((a,b)=>{
      const A = norm(a[0]);
      const B = norm(b[0]);
      if(!A && !B) return 0;
      if(!A) return 1;
      if(!B) return -1;
      return collator.compare(A, B);
    });
    const novaMatriz = [header, ...linhas];
    novoWS = XLSX.utils.aoa_to_sheet(novaMatriz);
    sortedSheets.add(activeSheetName);
    statusEl.textContent = `Ordenado A–Z por 1ª coluna na aba "${activeSheetName}"`;
    previousStatus = statusEl.textContent;
    showToast('Ordenado com sucesso!');
  }

  currentWB.Sheets[activeSheetName] = novoWS;
  const idx = currentWB.SheetNames.indexOf(activeSheetName);
  const html = XLSX.utils.sheet_to_html(novoWS, { id:`sheet-${idx}`, header:'', footer:'' });
  const pane = document.querySelector(`.sheet[data-name="${CSS.escape(activeSheetName)}"]`);
  if(pane) {
    pane.innerHTML = html;
    bindTableInteractions(pane);
  }
}

/* ========= SUBSTITUIÇÕES (UI sem popups) ========= */
function normalizeKey(s){ return (s||'').toString().replace(/\s+/g,' ').trim().toUpperCase(); }

// backward-compat parser (não é usado pela UI principal, mas útil se migrarmos dados antigos)
function parseMappingFromText(text){
  const dict = {};
  const lines = text.split(/\r?\n/);
  lines.forEach(line=>{
    let t = line.trim();
    if(!t) return;
    if(t.startsWith('#')) return;
    const parts = t.split(/\s*(?:⇢|=>|=|->|\t)\s*/);
    const left = (parts[0] || '').trim();
    const right = (parts.slice(1).join(' = ') || '').trim();
    if(!left) return;
    dict[normalizeKey(left)] = right;
  });
  return dict;
}

/* armazenamento e gerenciamento de conjuntos (localStorage v3 estrutura: { name: [ {k,v}, ... ] }) */
function loadSubstSets(){
  try{
    const raw = localStorage.getItem(SUBST_LS_KEY);
    if(!raw) {
      // cria set padrão vazio + 'Supermercado Josildo' com as trocas atualizadas
      const sets = {
        'Padrão': [],
        'Supermercado Josildo': [
          {k:'BISC.PARA FRITAR 1KG', v:'Biscoitinho de doce 1 kg'},
          {k:'BOLO FUBA CREMOSO', v:'Bolo cremoso de fubá 1 unidade'},
          {k:'BOLO PAMONHA', v:'Bolo cremoso de milho 1 unidade'},
          {k:'CHIPA PACOTE 7 KG', v:'Biscoito chipa 7kg'},
          {k:'COXINHA GRANDE UND.', v:'Coxinha de frango grande 10 unidades'},
          {k:'CROISSANT FRANGO', v:'Croissant de frango 7kg'},
          {k:'EMPADA FGO UND', v:'Empada de frango grande 10 unidades'},
          {k:'ENROLADO PRES.MUSSARELA GDE', v:'Enroladinho presunto mussarela grande 10 unidades'},
          {k:'ENROLADO SALSICHA GDE', v:'Enroladinho de salsicha grande 10 unidades'},
          {k:'PAO 6 HORAS', v:'Pão francês 06h 7kg'},
          {k:'PAO 12 HORAS', v:'Pão francês 12h 7kg'},
          {k:'PAO 18 HORAS', v:'Pão francês 18h 7kg'},
          {k:'PAO CARIOCA  5KG', v:'Carioca 7kg'},
          {k:'PAO DE BATATA 5KG', v:'Pão de batata 7kg'},
          {k:'PAO DE MILHO 5KG', v:'Pão de milho 7kg'},
          {k:'PAO FRANCES  BOLINHA 6HS', v:'Panhoca 06h 7kg'},
          {k:'PAO INTEGRAL PACT. 6 HORAS', v:'Pão francês integral 06h 7kg'},
          {k:'PAO ROSCOVADO', v:'Roscovado comum 1 unidade'},
          {k:'PASTEL FRANGO UND', v:'Pastel assado de frango grande 10 unidades'},
          {k:'QUIBE REDONDO', v:'Quibe grande 10 unidades'},
          {k:'ROSCA  REDONDA CREME', v:'Rosca creme e coco redonda 5 unidades'},
          {k:'ROSCA COMPRIDA CREME', v:'Rosca creme e coco comprida 5 unidades'},
          {k:'ROSCA COMPRIDA FRUTAS', v:'Rosca frutas cristalizadas comprida 5 unidades'},
          {k:'ROSCA REDONDA FRUTAS', v:'Rosca frutas cristalizadas redonda 5 unidades'},
          {k:'TORTA CATUPIRY UND.', v:'Empadão de frango com catupiry 10 unidades'}
        ]
      };
      saveSubstSets(sets);
      return sets;
    }
    const parsed = JSON.parse(raw);
    // backward-compat: if values are strings (old format), convert to array of {k,v}
    const out = {};
    Object.keys(parsed).forEach(name=>{
      const val = parsed[name];
      if(typeof val === 'string'){
        const dict = parseMappingFromText(val);
        out[name] = Object.keys(dict).map(k=>({k:k, v:dict[k]}));
      }else if(Array.isArray(val)){
        out[name] = val.map(item=>({k:item.k||'', v:item.v||''}));
      }else if(typeof val === 'object'){
        // if it was stored as map {key: value}, convert
        out[name] = Object.keys(val).map(k=>({k:k, v:val[k]}));
      }else{
        out[name] = [];
      }
    });
    return out;
  }catch(e){ console.warn(e); return null; }
}
function saveSubstSets(obj){
  try{ localStorage.setItem(SUBST_LS_KEY, JSON.stringify(obj)); }catch(e){ console.warn(e); }
}

function populateSubstSetsUI(){
  const select = document.getElementById('subst-sets');
  select.innerHTML = '';
  let sets = loadSubstSets();
  if(!sets){
    // cria set padrão vazio + 'Supermercado Josildo' com as trocas que o usuário mencionou
    sets = {
      'Padrão': [],
      'Supermercado Josildo': [
        {k:'BISC.PARA FRITAR 1KG', v:'Biscoitinho de doce 1 kg'},
        {k:'BOLO FUBA CREMOSO', v:'Bolo cremoso de fubá 1 unidade'},
        {k:'BOLO PAMONHA', v:'Bolo cremoso de milho 1 unidade'},
        {k:'CHIPA PACOTE 7 KG', v:'Biscoito chipa 7kg'},
        {k:'COXINHA GRANDE UND.', v:'Coxinha de frango grande 10 unidades'},
        {k:'CROISSANT FRANGO', v:'Croissant de frango 7kg'},
        {k:'EMPADA FGO UND', v:'Empada de frango grande 10 unidades'},
        {k:'ENROLADO PRES.MUSSARELA GDE', v:'Enroladinho presunto mussarela grande 10 unidades'},
        {k:'ENROLADO SALSICHA GDE', v:'Enroladinho de salsicha grande 10 unidades'},
        {k:'PAO 6 HORAS', v:'Pão francês 06h 7kg'},
        {k:'PAO 12 HORAS', v:'Pão francês 12h 7kg'},
        {k:'PAO 18 HORAS', v:'Pão francês 18h 7kg'},
        {k:'PAO CARIOCA  5KG', v:'Carioca 7kg'},
        {k:'PAO DE BATATA 5KG', v:'Pão de batata 7kg'},
        {k:'PAO DE MILHO 5KG', v:'Pão de milho 7kg'},
        {k:'PAO FRANCES  BOLINHA 6HS', v:'Panhoca 06h 7kg'},
        {k:'PAO INTEGRAL PACT. 6 HORAS', v:'Pão francês integral 06h 7kg'},
        {k:'PAO ROSCOVADO', v:'Roscovado comum 1 unidade'},
        {k:'PASTEL FRANGO UND', v:'Pastel assado de frango grande 10 unidades'},
        {k:'QUIBE REDONDO', v:'Quibe grande 10 unidades'},
        {k:'ROSCA  REDONDA CREME', v:'Rosca creme e coco redonda 5 unidades'},
        {k:'ROSCA COMPRIDA CREME', v:'Rosca creme e coco comprida 5 unidades'},
        {k:'ROSCA COMPRIDA FRUTAS', v:'Rosca frutas cristalizadas comprida 5 unidades'},
        {k:'ROSCA REDONDA FRUTAS', v:'Rosca frutas cristalizadas redonda 5 unidades'},
        {k:'TORTA CATUPIRY UND.', v:'Empadão de frango com catupiry 10 unidades'}
      ]
    };
    saveSubstSets(sets);
  }
  Object.keys(sets).forEach(name=>{
    const opt = document.createElement('option'); opt.value = name; opt.textContent = name; select.appendChild(opt);
  });
  // Removida a opção "+ Novo" conforme solicitado

  // listener que trata seleção de conjuntos
  select.onchange = function(){
    const val = select.value;
    renderMappingSet(val);
    updateEditButtonVisibility();
  };
}

function renderMappingSet(name){
  const sets = loadSubstSets() || {};
  const arr = sets[name] || [];
  const list = document.getElementById('subst-list');
  list.innerHTML = '';

  // Inicializa o estado expandido se não existir
  if (expandedSets[name] === undefined) {
    expandedSets[name] = false;
  }

  // Determina quantos itens mostrar
  const maxInitial = 5;
  const showAll = expandedSets[name];
  const itemsToShow = showAll ? arr : arr.slice(0, maxInitial);

  // Renderiza os itens
  itemsToShow.forEach(item => addMappingRow(item.k || '', item.v || ''));

  // Adiciona o botão "Ver mais" se houver mais de 5 itens e não estiver expandido
  if (arr.length > maxInitial && !showAll) {
    const moreRow = document.createElement('div');
    moreRow.className = 'map-row';
    moreRow.style.justifyContent = 'center';
    const moreBtn = document.createElement('button');
    moreBtn.className = 'show-more-btn';
    moreBtn.textContent = `Ver mais (${arr.length - maxInitial} itens)`;
    moreBtn.addEventListener('click', () => {
      expandedSets[name] = true;
      renderMappingSet(name);
    });
    moreRow.appendChild(moreBtn);
    list.appendChild(moreRow);
  }
  // Adiciona o botão "Ver menos" se estiver expandido
  else if (showAll && arr.length > maxInitial) {
    const lessRow = document.createElement('div');
    lessRow.className = 'map-row';
    lessRow.style.justifyContent = 'center';
    const lessBtn = document.createElement('button');
    lessBtn.className = 'show-more-btn';
    lessBtn.textContent = `Ver menos`;
    lessBtn.addEventListener('click', () => {
      expandedSets[name] = false;
      renderMappingSet(name);
    });
    lessRow.appendChild(lessBtn);
    list.appendChild(lessRow);
  }

  updateSubstUIState();
  updateEditButtonVisibility();
  updateReadonlyMode();
}

function updateEditButtonVisibility() {
  const select = document.getElementById('subst-sets');
  const currentSet = select.value;
  const editBtn = document.getElementById('btn-edit-set');
  const addBtn = document.getElementById('btn-add-mapping');
  
  if (currentSet === 'Padrão') {
    editBtn.style.display = 'none';
    addBtn.style.display = 'none';
  } else {
    editBtn.style.display = 'flex';
    if (isEditMode) {
      addBtn.style.display = 'flex';
    } else {
      addBtn.style.display = 'none';
    }
  }
}

function toggleEditMode() {
  isEditMode = !isEditMode;
  const editBtn = document.getElementById('btn-edit-set');
  const addBtn = document.getElementById('btn-add-mapping');
  
  if (isEditMode) {
    editBtn.innerHTML = 'Salvar';
    editBtn.title = 'Salvar edições';
    addBtn.style.display = 'flex';
  } else {
    editBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 3.99997H6C4.89543 3.99997 4 4.8954 4 5.99997V18C4 19.1045 4.89543 20 6 20H18C19.1046 20 20 19.1045 20 18V12M18.4142 8.41417L19.5 7.32842C20.281 6.54737 20.281 5.28104 19.5 4.5C18.7189 3.71895 17.4526 3.71895 16.6715 4.50001L15.5858 5.58575M18.4142 8.41417L12.3779 14.4505C12.0987 14.7297 11.7431 14.9201 11.356 14.9975L8.41422 15.5858L9.00257 12.6441C9.08001 12.2569 9.27032 11.9013 9.54951 11.6221L15.5858 5.58575M18.4142 8.41417L15.5858 5.58575" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`;
    editBtn.title = 'Editar conjunto';
    addBtn.style.display = 'none';
    // Salvar as alterações ao sair do modo de edição
    saveCurrentSet();
  }
  
  updateReadonlyMode();
  updateEditButtonVisibility();
}

function updateReadonlyMode() {
  const list = document.getElementById('subst-list');
  const inputs = list.querySelectorAll('.map-key, .map-val');
  
  if (isEditMode) {
    list.classList.remove('readonly-mode');
    inputs.forEach(input => {
      input.disabled = false;
    });
  } else {
    list.classList.add('readonly-mode');
    inputs.forEach(input => {
      input.disabled = true;
    });
  }
}

/* Modal para Novo */
function showNewModal(){
  const modal = document.getElementById('newModal');
  const input = document.getElementById('newName');
  input.value = 'Novo conjunto';
  modal.style.display = 'flex';
  input.focus();
}

function closeNewModal(){
  document.getElementById('newModal').style.display = 'none';
}

function confirmNew(){
  const name = document.getElementById('newName').value.trim();
  if(!name){ showInlineWarning('Digite um nome válido.'); return; }
  if(name === 'Padrão'){ showInlineWarning('Não é permitido gravar no conjunto "Padrão". Escolha outro nome.'); return; }
  const sets = loadSubstSets() || {};
  if(sets[name]){ showInlineWarning('Já existe um conjunto com esse nome. Escolha outro.'); return; }
  
  sets[name] = [];
  saveSubstSets(sets);
  populateSubstSetsUI();
  document.getElementById('subst-sets').value = name;
  renderMappingSet(name);
  closeNewModal();
  showToast('Conjunto criado.');
  // Entrar automaticamente no modo de edição para novos conjuntos
  isEditMode = true;
  toggleEditMode();
}

function showInlineWarning(msg){
  const w = document.getElementById('subst-warning');
  w.textContent = msg; w.style.display = 'block';
}

function showSaveAsModal(){
  const modal = document.getElementById('saveAsModal');
  const input = document.getElementById('saveAsName');
  const select = document.getElementById('subst-sets');
  const current = select.value || '';
  input.value = current ? current + ' - cópia' : 'Novo conjunto';
  modal.style.display = 'flex';
  input.focus();
}

function closeSaveAsModal(){
  document.getElementById('saveAsModal').style.display = 'none';
}

function confirmSaveAs(){
  const name = document.getElementById('saveAsName').value.trim();
  if(!name){ showInlineWarning('Digite um nome válido.'); return; }
  if(name === 'Padrão'){ showInlineWarning('Não é permitido gravar no conjunto "Padrão". Escolha outro nome.'); return; }
  const sets = loadSubstSets() || {};
  if(sets[name]){ showInlineWarning('Já existe um conjunto com esse nome. Escolha outro.'); return; }
  
  sets[name] = getMappingsFromUI();
  saveSubstSets(sets);
  populateSubstSetsUI();
  document.getElementById('subst-sets').value = name;
  renderMappingSet(name);
  closeSaveAsModal();
  showToast('Conjunto salvo como ' + name);
  updateEditButtonVisibility();
}

function showDeleteModal(){
  const select = document.getElementById('subst-sets');
  const name = select.value;
  if(!name) return;
  if(name === 'Padrão'){ showInlineWarning('O conjunto "Padrão" não pode ser excluído.'); return; }
  
  const modal = document.getElementById('deleteModal');
  const span = document.getElementById('delete-set-name');
  span.textContent = name;
  modal.style.display = 'flex';
}

function closeDeleteModal(){
  document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete(){
  const select = document.getElementById('subst-sets');
  const name = select.value;
  const sets = loadSubstSets() || {};
  delete sets[name];
  saveSubstSets(sets);
  populateSubstSetsUI();
  document.getElementById('subst-sets').value = Object.keys(loadSubstSets() || {})[0] || '';
  renderMappingSet(document.getElementById('subst-sets').value);
  showToast('Conjunto excluído.');
  updateEditButtonVisibility();
  closeDeleteModal();
}

function restoreOriginalsFromUI(){
  // restaura apenas aba ativa (mantive a opção simples conforme UI atual)
  restoreOriginals({ allSheets: false });
}

function restoreOriginals({ allSheets = false } = {}){
  if(!currentWB){ showToast('Nenhum arquivo carregado.'); return; }
  const targetSheets = allSheets ? currentWB.SheetNames.slice() : (activeSheetName ? [activeSheetName] : []);
  let restoredCount = 0;
  targetSheets.forEach(name=>{
    const orig = originalSheetsAOA[name];
    if(!orig) return;
    const novoWS = XLSX.utils.aoa_to_sheet(orig.map(r=>Array.isArray(r)?r.slice():[]));
    currentWB.Sheets[name] = novoWS;
    const idx = currentWB.SheetNames.indexOf(name);
    const html = XLSX.utils.sheet_to_html(novoWS, { id:`sheet-${idx}`, header:'', footer:'' });
    const pane = document.querySelector(`.sheet[data-name="${CSS.escape(name)}"]`);
    if(pane) { pane.innerHTML = html; bindTableInteractions(pane); }
    substitutionAppliedSheets.delete(name);
    sortedSheets.delete(name);
    restoredCount++;
  });
  updateSubstUIState();
  statusEl.textContent = `Restauradas ${restoredCount} aba(s) ao original.`;
  previousStatus = statusEl.textContent;
  showToast('Conteúdo original restaurado.');
}

function getMappingsFromUI(){
  const rows = Array.from(document.querySelectorAll('.subst-list .map-row'));
  const out = [];
  rows.forEach(row=>{
    const k = (row.querySelector('.map-key')?.value || '').toString().trim();
    const v = (row.querySelector('.map-val')?.value || '').toString().trim();
    if(k) out.push({k:k, v:v});
  });
  return out;
}

function addMappingRow(key, val){
  const list = document.getElementById('subst-list');
  const row = document.createElement('div'); row.className = 'map-row';
  const inputK = document.createElement('input'); inputK.className = 'map-key'; inputK.value = key || '';
  const arrow = document.createElement('div'); arrow.className = 'map-arrow';
  arrow.innerHTML = `<svg width="20" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 12h14" stroke="#666" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 5l6 7-6 7" stroke="#666" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  const inputV = document.createElement('input'); inputV.className = 'map-val'; inputV.value = val || '';
  const del = document.createElement('button'); del.className = 'map-del'; del.title='Remover mapeamento'; del.innerHTML = '✕';
  del.addEventListener('click', (e)=>{ 
    e.stopPropagation(); 
    row.remove(); 
    // Atualizar o conjunto salvo
    const select = document.getElementById('subst-sets');
    const currentSetName = select.value;
    const sets = loadSubstSets() || {};
    const currentSet = sets[currentSetName] || [];
    
    // Encontrar o índice do item a ser removido
    const rows = Array.from(list.querySelectorAll('.map-row'));
    const index = rows.indexOf(row);
    if (index > -1) {
      currentSet.splice(index, 1);
      saveSubstSets(sets);
      renderMappingSet(currentSetName);
    }
    
    updateSubstUIState(); 
    showToast('Mapeamento removido.'); 
  });
  row.appendChild(inputK); row.appendChild(arrow); row.appendChild(inputV); row.appendChild(del);
  list.appendChild(row);

  // Aplicar o estado de edição aos novos inputs
  if (!isEditMode) {
    inputK.disabled = true;
    inputV.disabled = true;
  }

  inputK.focus();
}

function saveCurrentSet() {
  const select = document.getElementById('subst-sets');
  const currentSetName = select.value;
  if (!currentSetName) return;
  const sets = loadSubstSets() || {};
  sets[currentSetName] = getMappingsFromUI();
  saveSubstSets(sets);
}

function applySubstitutionsFromUI(){
  if(!currentWB){ showToast('Nenhum arquivo carregado.'); return; }
  const select = document.getElementById('subst-sets');
  const currentSetName = select.value;
  const sets = loadSubstSets() || {};
  const mappings = sets[currentSetName] || [];
  substitutionDict = {};
  mappings.forEach(m=>{ substitutionDict[normalizeKey(m.k)] = m.v; });
  // Apply only to active sheet by default (UI atualmente aplica aba ativa)
  applySubstitutions({ allSheets: false });
}

function applySubstitutions({ allSheets = false } = {}){
  if(!currentWB){ showToast('Nenhum arquivo carregado.'); return; }
  let totalReplacements = 0;
  const targetSheets = allSheets ? currentWB.SheetNames.slice() : (activeSheetName ? [activeSheetName] : []);
  targetSheets.forEach(name=>{
    const ws = currentWB.Sheets[name];
    if(!ws) return;
    const aoa = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
    let replaced = 0;
    for(let r=0;r<aoa.length;r++){
      for(let c=0;c<aoa[r].length;c++){
        const cell = aoa[r][c];
        if(cell === null || cell === undefined) continue;
        const norm = normalizeKey(cell.toString());
        if(Object.prototype.hasOwnProperty.call(substitutionDict, norm)){
          aoa[r][c] = substitutionDict[norm];
          replaced++;
        }
      }
    }
    if(replaced>0){
      const novoWS = XLSX.utils.aoa_to_sheet(aoa);
      currentWB.Sheets[name] = novoWS;
      const idx = currentWB.SheetNames.indexOf(name);
      const html = XLSX.utils.sheet_to_html(novoWS, { id:`sheet-${idx}`, header:'', footer:'' });
      const pane = document.querySelector(`.sheet[data-name="${CSS.escape(name)}"]`);
      if(pane) { pane.innerHTML = html; bindTableInteractions(pane); }
      substitutionAppliedSheets.add(name);
      totalReplacements += replaced;
    }
  });
  updateSubstUIState();
  statusEl.textContent = `Substituições aplicadas (${totalReplacements} trocas).`;
  previousStatus = statusEl.textContent;
  showToast(`${totalReplacements} substituição(ões) aplicadas.`);
}

function updateSubstUIState(){
  const btn = document.getElementById('btn-subst');
  if(!btn) return;
  const applied = activeSheetName && substitutionAppliedSheets.has(activeSheetName);
  btn.title = applied ? 'Substituições aplicadas (abrir painel)' : 'Substituições (abrir painel)';
}

/* carrega conjuntos salvos e inicializa a UI */
(function initSubstDict(){
  try{
    populateSubstSetsUI();
    const select = document.getElementById('subst-sets');
    select.value = Object.keys(loadSubstSets() || {})[0] || '';
    renderMappingSet(select.value);
    // substitute: attach stopPropagation for interaction inside panel to avoid accidental fechamento
    const dropdownSubst = document.getElementById('dropdown-subst');
    if(dropdownSubst) dropdownSubst.addEventListener('click', (e)=>{ e.stopPropagation(); });
    // ensure some buttons inside panel don't propagate clicks to document (avoid fechar menus)
    ['btn-add-mapping','btn-new','btn-save-as','btn-delete-set','btn-apply-subst','btn-restore-original','btn-sort-subst', 'btn-edit-set'].forEach(id=>{
      const el = document.getElementById(id); if(el) el.addEventListener('click', (e)=> e.stopPropagation());
    });
    // make add mapping button add row without inline onclick (we also keep the inline but ensure it doesn't close the menu)
    const addBtn = document.getElementById('btn-add-mapping'); 
    if(addBtn) addBtn.addEventListener('click', ()=> {
      const select = document.getElementById('subst-sets');
      const currentSetName = select.value;
      if (currentSetName === 'Padrão') return; // Não adicionar ao Padrão

      const sets = loadSubstSets() || {};
      const currentSet = sets[currentSetName] || [];
      currentSet.push({k: '', v: ''});
      saveSubstSets(sets);
      renderMappingSet(currentSetName);
    });
    
    // Botão de editar
    const editBtn = document.getElementById('btn-edit-set');
    if (editBtn) {
      editBtn.addEventListener('click', toggleEditMode);
    }
    
    updateEditButtonVisibility();
    updateReadonlyMode();

    // substitutionDict vazio até o usuário aplicar
    substitutionDict = {};
  }catch(e){ console.warn('Não foi possível inicializar painel de substituições', e); }
})();

/* ========= final helpers ========= */
updateSubstUIState();

/* ========= SELEÇÃO DE CÉLULAS (simples) ========= */
function bindTableInteractions(pane){
  const table = pane.querySelector('table');
  if(!table) return;
  const tb = table.tBodies[0];
  if(!tb) return;
  Array.from(tb.rows).forEach((row, rIdx)=>{
    Array.from(row.cells).forEach((td, cIdx)=>{
      td.dataset.r = rIdx;
      td.dataset.c = cIdx;
      td.style.userSelect = 'none';
      td.addEventListener('mousedown', cell_mouse_down);
      td.addEventListener('mouseenter', cell_mouse_enter);
      td.addEventListener('mouseup', cell_mouse_up);
    });
  });
}

function cell_mouse_down(e){
  if(e.button !== 0) return;
  isSelecting = true;
  const td = e.currentTarget;
  selectStart = { r: Number(td.dataset.r), c: Number(td.dataset.c) };
  if(!e.ctrlKey && !e.metaKey){ clearSelection(); }
  toggleCellSelection(td);
}
function cell_mouse_enter(e){
  if(!isSelecting) return;
  const td = e.currentTarget;
  if(selectStart){
    const r2 = Number(td.dataset.r); const c2 = Number(td.dataset.c);
    selectRange(selectStart.r, selectStart.c, r2, c2);
  }
}
function cell_mouse_up(e){
  isSelecting = false; selectStart = null;
}

function cellKey(k){ return `${k.r}|${k.c}`; }

function selectRange(r1,c1,r2,c2){
  clearSelection();
  const rmin = Math.min(r1,r2); const rmax = Math.max(r1,r2);
  const cmin = Math.min(c1,c2); const cmax = Math.max(c1,c2);
  const activePane = document.querySelector('.sheet.active');
  if(!activePane) return;
  const table = activePane.querySelector('table'); if(!table) return;
  const tb = table.tBodies[0]; if(!tb) return;
  for(let r=rmin;r<=rmax;r++){
    const row = tb.rows[r]; if(!row) continue;
    for(let c=cmin;c<=cmax;c++){
      const cell = row.cells[c]; if(!cell) continue;
      cell.classList.add('cell-selected');
      selectedCells.add(`${r}|${c}`);
    }
  }
  updateSelectionCount();
}

function toggleCellSelection(td){
  const key = `${td.dataset.r}|${td.dataset.c}`;
  if(selectedCells.has(key)){
    selectedCells.delete(key); td.classList.remove('cell-selected');
  }else{
    selectedCells.add(key); td.classList.add('cell-selected');
  }
  updateSelectionCount();
}

function clearSelection(){
  const activePane = document.querySelector('.sheet.active');
  if(activePane){
    activePane.querySelectorAll('td.cell-selected').forEach(td=>td.classList.remove('cell-selected'));
  }
  selectedCells.clear();
  updateSelectionCount();
}

function updateSelectionCount(){
  const activePane = document.querySelector('.sheet.active');
  if(!activePane){ selCountEl.textContent = '0'; statusEl.textContent = previousStatus; return; }
  const selected = Array.from(activePane.querySelectorAll('td.cell-selected'));
  // contar apenas células não vazias (com texto visível)
  const nonEmptySelected = selected.filter(td => (td.textContent || '').toString().trim() !== '');
  selCountEl.textContent = nonEmptySelected.length.toString();
  const rightSel = document.getElementById('right-selection');
  if(nonEmptySelected.length>0) {
    statusEl.textContent = `${nonEmptySelected.length} célula(s) selecionada(s)`;
  } else {
    statusEl.textContent = previousStatus;
  }
}

/* ========= substituições - botão condicional (abre painel somente se arquivo carregado) ========= */
function toggleSubstMenu(e){
  // if there is no workbook loaded, show short menu (like salvar/copiar)
  if(!currentWB){
    // Mostrar aviso quando não há arquivo
    const noFileWarning = document.getElementById('no-file-warning');
    noFileWarning.style.display = 'block';
    
    // Esconder outros elementos
    document.getElementById('subst-list').style.display = 'none';
    document.getElementById('btn-add-mapping').style.display = 'none';
    document.querySelector('.separator').style.display = 'none';
    
    toggleMenu('dropdown-subst');
    return;
  } else {
    // Esconder aviso quando há arquivo
    document.getElementById('no-file-warning').style.display = 'none';
    document.getElementById('subst-list').style.display = 'flex';
    document.querySelector('.separator').style.display = 'block';
  }
  toggleMenu('dropdown-subst');
}

/* ========= pequenas utilidades visuais para o painel ========= */
function showSubstInlineMessage(msg, timeout=4000){
  const el = document.getElementById('subst-warning');
  el.textContent = msg; el.style.display = 'block';
  clearTimeout(showSubstInlineMessage._t);
  showSubstInlineMessage._t = setTimeout(()=>{ el.style.display='none'; }, timeout);
}

/* ========= finalização ========= */
// ready
</script>
</body>
</html>
