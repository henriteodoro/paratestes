<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Menu Inicial — MACs & Guias</title>
<!-- SheetJS (permite abrir .ods/.xlsx no navegador) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  /* ========= Base visual ========= */
  :root{
    --azul:#007BFF;
    --fundo:#fbfcfe;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#0b5ed7;
  }
  html,body { height:100%; margin:0; }
  body{
    font-family: monospace;
    background: linear-gradient(180deg,#f7fbff 0%, #ffffff 100%);
    color:#111;
    -webkit-font-smoothing:antialiased;
    padding:18px;
  }
  .wrap {
    max-width: 980px;
    margin: 0 auto;
  }
  h1 { margin:0 0 12px 0; font-size:20px; color:var(--accent); }
  p.lead { margin:4px 0 18px 0; color:var(--muted); font-size:13px; }

  /* ========= Top cards (PDFs) ========= */
  .top-grid {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
    margin-bottom:18px;
  }
  .card {
    background: var(--card);
    border: 1px solid #e6eefc;
    padding:12px;
    border-radius:8px;
    box-shadow: 0 4px 12px rgba(11,78,167,0.04);
  }
  .card a{ text-decoration:none; color:var(--azul); font-weight:600; display:block; }
  .card small { color:var(--muted); display:block; margin-top:8px; font-size:12px; }

  /* ========= Menu list (colapsáveis) ========= */
  .menu-list { margin: 6px 0 18px 0; display:block; }
  .section {
    margin-bottom:8px;
  }
  .section-head {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    cursor:pointer;
    padding:10px;
    border-radius:8px;
    background: #fff;
    border:1px solid #e9f2ff;
  }
  .section-head:hover { background: #fbfdff; }
  .section-title {
    display:flex;
    gap:10px;
    align-items:center;
  }
  .section-title .badge {
    background:var(--azul);
    color:white;
    padding:4px 8px;
    border-radius:6px;
    font-size:12px;
  }
  .section-title h3 { margin:0; font-size:14px; color:#0b4fa0; }
  .chev {
    transition: transform .18s ease;
    font-size:16px;
    color:var(--muted);
  }
  .chev.open { transform:rotate(90deg); color: var(--azul); }

  .section-body {
    max-height:0;
    overflow:hidden;
    transition: max-height .26s ease, padding .18s ease;
    padding:0 10px;
  }
  .section-body.open {
    padding:10px;
  }
  .list {
    list-style:none;
    margin:0;
    padding:0;
    display:block;
    gap:6px;
  }
  .list a {
    display:flex;
    justify-content:space-between;
    text-decoration:none;
    padding:8px;
    border-radius:6px;
    color:#0b3b6b;
    border:1px solid transparent;
    margin-bottom:6px;
  }
  .list a:hover { background:#f3f8ff; border-color:#e3f0ff; }
  .list .muted { color:var(--muted); font-size:12px; }

  /* ========= Sub-grid for guiass/somar etc (indented) ======== */
  .sublist { padding-left:6px; border-left:2px dashed #eef6ff; margin-top:6px; }

  /* ========= Em breve pill ======== */
  .soon {
    font-size:12px;
    color: #9aa0a6;
    font-style: italic;
  }

  /* ========= Footer/legend etc ======== */
  .meta { font-size:13px; color:var(--muted); margin-top:10px; }

  /* keyboard focus */
  .section-head:focus { outline: 3px solid rgba(0,123,255,0.12); }

  /* small UI elements (lista ordenada + ods) */
  .inline-row{ display:flex; gap:8px; align-items:center; }
  input[type="text"], input[type="file"]{ padding:8px; border-radius:6px; border:1px solid #e6eefc; font-family:inherit; }
  button.btn{ padding:6px 10px; border-radius:6px; border:0; cursor:pointer; background:var(--azul); color:white; font-weight:600; }
  button.btn.ghost{ background:transparent; color:var(--azul); border:1px solid #d8e9ff; }
  .li-item{ display:flex; align-items:center; gap:8px; padding:8px; border-radius:6px; border:1px solid #f0f6ff; margin-bottom:6px; background:#fff; }
  .li-item .num{ min-width:28px; font-weight:700; color:#0b3b6b; }
  .li-item .text{ flex:1; }
  .li-controls button{ margin-left:6px; padding:4px 8px; border-radius:6px; border:0; cursor:pointer; }
  .li-controls button.small{ padding:4px 6px; font-size:12px; }
  .small-muted{ font-size:12px; color:var(--muted); }

  /* tabela preview ods */
  .ods-preview{ overflow:auto; max-height:260px; border:1px solid #eef6ff; border-radius:6px; margin-top:8px; padding:6px; background:#fff; }
  table.ods-table{ border-collapse:collapse; width:100%; font-size:13px; }
  table.ods-table th, table.ods-table td{ border:1px solid #eef6ff; padding:6px; text-align:left; }

  /* Responsivo */
  @media (max-width:640px) {
    body { padding:14px; }
    .top-grid { grid-template-columns:1fr; }
    .inline-row{ flex-direction:column; align-items:stretch; }
  }
</style>
</head>
<body>
  <div class="wrap" role="main">
    <h1>Menu Inicial</h1>
    <p class="lead">Acesse MACs, Guias e Tabelas de Preço — clique para expandir / abrir. (pode editar links depois)</p>

    <!-- ======= PDFs (coloque os links nos href ou data-href) ======= -->
    <div class="top-grid" aria-label="Tabelas e Catálogo">
      <div class="card">
        <a href="#" data-href="#" target="_blank" id="link-tabela-geral">Tabela de Preços Geral</a>
        <small>Clique para abrir a tabela geral (PDF). Substitua o <code>href</code> pelo link do seu PDF.</small>
      </div>

      <div class="card">
        <a href="#" data-href="#" target="_blank" id="link-tabela-empresa">Tabela de Preços Empresa</a>
        <small>Tabela por empresa (em outra aba).</small>
      </div>

      <div class="card">
        <a href="#" data-href="#" target="_blank" id="link-catalogo">Catálogo</a>
        <small>Catálogo de produtos (PDF).</small>
      </div>
    </div>

    <!-- ======= Menu com seções colapsáveis ======= -->
    <nav class="menu-list" aria-label="Menu principal">

      <!-- MACS -->
      <section class="section" id="sec-macs">
        <div tabindex="0" class="section-head" role="button" aria-expanded="false" data-target="body-macs">
          <div class="section-title">
            <span class="badge">MACS</span>
            <h3>Lista de MACs</h3>
          </div>
          <div class="chev" aria-hidden="true">▶</div>
        </div>

        <div id="body-macs" class="section-body" aria-hidden="true">
          <ul class="list">
            <li><a href="mac77.html" class="mac-link">MAC Bairro São Geraldo - Cód. 77</a></li>
            <li><a href="mac78.html" class="mac-link">MAC Bairro Planalto - Cód. 78</a></li>
            <li><a href="mac79.html" class="mac-link">MAC Romeu Duarte - Cód. 79</a></li>
            <li><a href="mac80.html" class="mac-link">MAC Rua São Geraldo / Centro 2 - Cód. 80</a></li>
            <li><a href="mac277.html" class="mac-link">MAC Matriz - Cód. 277</a></li>
            <li><a href="mac853.html" class="mac-link">MAC Concesso - Cód. 853</a></li>
            <li><a href="mac1249.html" class="mac-link">MAC Jardim do Lago - Cód. 1249</a></li>
            <li><a href="mac989.html" class="mac-link">MAC Araújos - Cód. 989</a></li>
          </ul>
        </div>
      </section>

      <!-- São José -->
      <section class="section" id="sec-saojose">
        <div tabindex="0" class="section-head" role="button" aria-expanded="false" data-target="body-saojose">
          <div class="section-title">
            <span class="badge">São José</span>
            <h3>São José</h3>
          </div>
          <div class="chev" aria-hidden="true">▶</div>
        </div>

        <div id="body-saojose" class="section-body" aria-hidden="true">
          <ul class="list">
            <li><a href="#" class="plain-link">São José</a></li>
            <li><a href="#" class="plain-link">Pão Total</a></li>
          </ul>
        </div>
      </section>

      <!-- Guias -->
      <section class="section" id="sec-guias">
        <div tabindex="0" class="section-head" role="button" aria-expanded="false" data-target="body-guias">
          <div class="section-title">
            <span class="badge">Guias</span>
            <h3>Guias</h3>
          </div>
          <div class="chev" aria-hidden="true">▶</div>
        </div>

        <div id="body-guias" class="section-body" aria-hidden="true">
          <!-- Sub-item: Macs -->
          <div class="card" style="margin-bottom:8px;">
            <div tabindex="0" class="section-head sub-head" role="button" aria-expanded="false" data-target="body-guias-macs">
              <div class="section-title"><strong>Macs</strong></div>
              <div class="chev" aria-hidden="true">▶</div>
            </div>
            <div id="body-guias-macs" class="section-body sublist" aria-hidden="true">
              <ul class="list">
                <li><a href="mac77.html" class="mac-link">MAC 77 - Bairro São Geraldo</a></li>
                <li><a href="mac78.html" class="mac-link">MAC 78 - Bairro Planalto</a></li>
                <li><a href="mac79.html" class="mac-link">MAC 79 - Romeu Duarte</a></li>
                <li><a href="mac80.html" class="mac-link">MAC 80 - Rua São Geraldo / Centro 2</a></li>
                <li><a href="mac277.html" class="mac-link">MAC 277 - Matriz</a></li>
                <li><a href="mac853.html" class="mac-link">MAC 853 - Concesso</a></li>
                <li><a href="mac1249.html" class="mac-link">MAC 1249 - Jardim do Lago</a></li>
                <li><a href="mac989.html" class="mac-link">MAC 989 - Araújos</a></li>
              </ul>
            </div>
          </div>

          <!-- Sub-item: Fidelis -->
          <div class="card" style="margin-bottom:8px;">
            <div tabindex="0" class="section-head sub-head" role="button" aria-expanded="false" data-target="body-guias-fidelis">
              <div class="section-title"><strong>Fidelis</strong></div>
              <div class="chev" aria-hidden="true">▶</div>
            </div>
            <div id="body-guias-fidelis" class="section-body sublist" aria-hidden="true">
              <div class="soon">Em breve</div>
            </div>
          </div>

          <!-- Sub-item: Somar -->
          <div class="card" style="margin-bottom:8px;">
            <div tabindex="0" class="section-head sub-head" role="button" aria-expanded="false" data-target="body-guias-somar">
              <div class="section-title"><strong>Somar</strong></div>
              <div class="chev" aria-hidden="true">▶</div>
            </div>
            <div id="body-guias-somar" class="section-body sublist" aria-hidden="true">
              <ul class="list">
                <li>Comércio de Alimentos Teixeira Rabelo Carmo do Cajuru - Cód. 796</li>
                <li>Somar Rua Joaquim Nabuco Bairro Porto Velho - Cód. 782</li>
                <li>Kit do Adriano - Cód. 793</li>
                <li>Kit 2 Irmãos - Cód. 794</li>
                <li>Somar Rua Bom Sucesso Bairro Nações - Cód. 795</li>
                <li>Somar Av. Espírito Santo Bairro Sidil - Cód. 797</li>
                <li>Somar Perdigão - Cód. 1260</li>
              </ul>
            </div>
          </div>

          <!-- Sub-item: Ester Amaral -->
          <div class="card" style="margin-bottom:8px;">
            <div tabindex="0" class="section-head sub-head" role="button" aria-expanded="false" data-target="body-guias-ester">
              <div class="section-title"><strong>Ester Amaral</strong></div>
              <div class="chev" aria-hidden="true">▶</div>
            </div>
            <div id="body-guias-ester" class="section-body sublist" aria-hidden="true">
              <ul class="list">
                <li>rua rio de janeiro cod 854</li>
                <li>rua bahia cod 33</li>
                <li>torre gourmet quinta cod 1102</li>
                <li>rua itumiritinga bom pastor - cod 296</li>
              </ul>
            </div>
          </div>

        </div>
      </section>

      <!-- NOVO: Lista Ordenada -->
      <section class="section" id="sec-lista-ordenada">
        <div tabindex="0" class="section-head" role="button" aria-expanded="false" data-target="body-lista-ordenada">
          <div class="section-title">
            <span class="badge">Listas</span>
            <h3>Lista Ordenada</h3>
          </div>
          <div class="chev" aria-hidden="true">▶</div>
        </div>

        <div id="body-lista-ordenada" class="section-body" aria-hidden="true">
          <div class="card">
            <div class="inline-row" style="margin-bottom:8px;">
              <input aria-label="Novo item" id="list-item-input" type="text" placeholder="Adicionar item...">
              <button id="list-add-btn" class="btn">Adicionar</button>
              <button id="list-clear-btn" class="btn ghost" title="Limpar lista">Limpar</button>
            </div>

            <div id="list-container" aria-live="polite">
              <ol id="ordered-list" class="list" style="padding-left:8px;"></ol>
            </div>

            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
              <button id="list-copy" class="btn ghost">Copiar</button>
              <button id="list-download-txt" class="btn ghost">Baixar .txt</button>
              <button id="list-download-csv" class="btn ghost">Baixar .csv</button>
              <div class="small-muted" style="margin-left:auto; align-self:center;">Use as setas para reordenar.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- NOVO: Abrir arquivo .ODS -->
      <section class="section" id="sec-abrir-ods">
        <div tabindex="0" class="section-head" role="button" aria-expanded="false" data-target="body-abrir-ods">
          <div class="section-title">
            <span class="badge">Arquivo</span>
            <h3>Abrir arquivo .ODS / .XLSX</h3>
          </div>
          <div class="chev" aria-hidden="true">▶</div>
        </div>

        <div id="body-abrir-ods" class="section-body" aria-hidden="true">
          <div class="card">
            <div class="inline-row" style="align-items:flex-start; gap:10px;">
              <input id="ods-file-input" type="file" accept=".ods,.xlsx,.xls" aria-label="Selecionar arquivo ODS"> 
              <div style="display:flex; gap:8px; flex-direction:column;">
                <button id="ods-open-btn" class="btn">Abrir</button>
                <button id="ods-export-csv" class="btn ghost">Exportar CSV</button>
                <button id="ods-export-xlsx" class="btn ghost">Exportar XLSX</button>
              </div>
            </div>

            <div id="ods-status" class="small-muted" style="margin-top:8px;">Nenhum arquivo carregado.</div>
            <div id="ods-preview" class="ods-preview" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <!-- lista de média por pacote (em breve) -->
      <section class="section" id="sec-media">
        <div tabindex="0" class="section-head" role="button" aria-expanded="false" data-target="body-media">
          <div class="section-title">
            <span class="badge">Média</span>
            <h3>Lista de média de produto por pacote</h3>
          </div>
          <div class="chev" aria-hidden="true">▶</div>
        </div>
        <div id="body-media" class="section-body" aria-hidden="true">
          <div class="soon">Em breve</div>
        </div>
      </section>

      <!-- relatório produção (em breve) -->
      <section class="section" id="sec-relatorio">
        <div tabindex="0" class="section-head" role="button" aria-expanded="false" data-target="body-relatorio">
          <div class="section-title">
            <span class="badge">Relatório</span>
            <h3>Relatório Produção</h3>
          </div>
          <div class="chev" aria-hidden="true">▶</div>
        </div>
        <div id="body-relatorio" class="section-body" aria-hidden="true">
          <div class="soon">Em breve</div>
        </div>
      </section>

    </nav>

    <div class="meta">Dica: clique no título ou na seta para abrir as opções. Substitua <code>#</code> pelos links dos PDFs quando estiver pronto.</div>
  </div>

<script>
/* ====== Código JS para toggles e comportamento ====== */

function toggleSection(headEl){
  const targetId = headEl.getAttribute('data-target') || headEl.dataset.target;
  if(!targetId) return;
  const body = document.getElementById(targetId);
  if(!body) return;
  const chev = headEl.querySelector('.chev') || headEl.querySelector('[aria-hidden="true"]');
  const isOpen = body.classList.contains('open');

  if(isOpen){
    body.style.maxHeight = null;
    body.classList.remove('open');
    headEl.setAttribute('aria-expanded','false');
    body.setAttribute('aria-hidden','true');
    if(chev) chev.classList.remove('open');
  } else {
    body.classList.add('open');
    body.style.maxHeight = body.scrollHeight + 24 + "px";
    headEl.setAttribute('aria-expanded','true');
    body.setAttribute('aria-hidden','false');
    if(chev) chev.classList.add('open');
  }
}

// delegação: adiciona listeners a todos os .section-head no menu
document.querySelectorAll('.section-head').forEach(head=>{
  head.addEventListener('click', (e)=>{
    toggleSection(head);
  });
  head.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      toggleSection(head);
    } else if(e.key === 'ArrowRight'){
      const targetId = head.dataset.target;
      const body = document.getElementById(targetId);
      if(body && !body.classList.contains('open')) toggleSection(head);
    } else if(e.key === 'ArrowLeft'){
      const targetId = head.dataset.target;
      const body = document.getElementById(targetId);
      if(body && body.classList.contains('open')) toggleSection(head);
    }
  });
});

// Close all open sections when clicking outside menu-list (optional)
document.addEventListener('click', (ev)=>{
  const menu = document.querySelector('.menu-list');
  if(!menu) return;
  if(menu.contains(ev.target)) return;
  document.querySelectorAll('#body-macs.open,#body-saojose.open,#body-guias.open,#body-media.open,#body-relatorio.open,#body-lista-ordenada.open,#body-abrir-ods.open').forEach(b=>{
    const head = document.querySelector(`[data-target="${b.id}"]`);
    if(head) toggleSection(head);
  });
});

/* ======= Abrir PDFs (use data-href ou trocar href) ======= */
function openPdfLink(elem){
  const href = elem.getAttribute('href');
  const dataHref = elem.getAttribute('data-href');
  const url = (href && href !== '#') ? href : (dataHref && dataHref !== '#') ? dataHref : null;
  if(!url){
    alert('Link do PDF ainda não configurado. Substitua o atributo href/data-href pelo URL do seu PDF.');
    return;
  }
  window.open(url, '_blank');
}
['link-tabela-geral','link-tabela-empresa','link-catalogo'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('click', (e)=>{
    e.preventDefault();
    openPdfLink(el);
  });
});

/* ======= Links MACs: agora NAVEGAM para os arquivos macXX.html ======= */
document.querySelectorAll('.mac-link').forEach(a=>{
  a.addEventListener('click', (e)=>{
    const href = (a.getAttribute('href') || '').trim();
    if (href && href !== '#') {
      // temos um arquivo definido — navegar para ele (mesma aba)
      e.preventDefault();
      window.location.href = href;
      return;
    }
    // sem href configurado -> aviso (mantive comportamento antigo)
    e.preventDefault();
    const txt = a.textContent.trim();
    alert(`${txt}\n\n(Em breve: substitua por link real para abrir a página do MAC)`);
  });
});

/* ======= Links simples (São José etc) ======= */
document.querySelectorAll('.plain-link').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    alert('Página ainda não disponível (em breve).');
  });
});

/* ======= Inicial: fecha todos os bodies (garantia) ======= */
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.section-body').forEach(b=>{
    b.style.maxHeight = null;
  });
});

/* ===================== NOVAS FUNCIONALIDADES: LISTA ORDENADA ===================== */
(function(){
  const input = document.getElementById('list-item-input');
  const addBtn = document.getElementById('list-add-btn');
  const listEl = document.getElementById('ordered-list');
  const clearBtn = document.getElementById('list-clear-btn');
  const copyBtn = document.getElementById('list-copy');
  const downloadTxt = document.getElementById('list-download-txt');
  const downloadCsv = document.getElementById('list-download-csv');

  function renderNumbering(){
    Array.from(listEl.children).forEach((li,i)=>{
      const num = li.querySelector('.num');
      if(num) num.textContent = (i+1) + '.';
    });
  }

  function createListItem(text){
    const li = document.createElement('li');
    li.className = 'li-item';

    li.innerHTML = `
      <div class="num">0.</div>
      <div class="text">${escapeHtml(text)}</div>
      <div class="li-controls" role="group" aria-label="Controles do item">
        <button class="small" data-action="up" title="Mover para cima">▲</button>
        <button class="small" data-action="down" title="Mover para baixo">▼</button>
        <button class="small" data-action="edit" title="Editar">✎</button>
        <button class="small" data-action="del" title="Remover">✖</button>
      </div>
    `;

    // eventos delegados abaixo serão capturados
    return li;
  }

  function escapeHtml(s){
    return s.replace(/[&<>\"']/g, function(c){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c];
    });
  }

  addBtn.addEventListener('click', ()=>{
    const v = (input.value || '').trim();
    if(!v) return input.focus();
    const li = createListItem(v);
    listEl.appendChild(li);
    input.value = '';
    renderNumbering();
  });

  input.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') addBtn.click();
  });

  listEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const action = btn.dataset.action;
    const li = btn.closest('li');
    if(!action || !li) return;

    if(action === 'up'){
      const prev = li.previousElementSibling;
      if(prev) li.parentNode.insertBefore(li, prev);
      renderNumbering();
    } else if(action === 'down'){
      const next = li.nextElementSibling;
      if(next) li.parentNode.insertBefore(next, li);
      renderNumbering();
    } else if(action === 'del'){
      li.remove();
      renderNumbering();
    } else if(action === 'edit'){
      const txtEl = li.querySelector('.text');
      const current = txtEl.textContent;
      const newv = prompt('Editar item:', current);
      if(newv !== null){
        txtEl.textContent = newv;
      }
    }
  });

  clearBtn.addEventListener('click', ()=>{
    if(!confirm('Limpar toda a lista?')) return;
    listEl.innerHTML = '';
  });

  copyBtn.addEventListener('click', async ()=>{
    const arr = Array.from(listEl.children).map(li=> li.querySelector('.text').textContent);
    const txt = arr.join('\n');
    try{
      await navigator.clipboard.writeText(txt);
      alert('Lista copiada para área de transferência.');
    }catch(err){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      alert('Lista copiada (fallback).');
    }
  });

  function download(filename, content, mime='text/plain'){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  downloadTxt.addEventListener('click', ()=>{
    const arr = Array.from(listEl.children).map(li=> li.querySelector('.text').textContent);
    download('lista.txt', arr.join('\n'), 'text/plain');
  });

  downloadCsv.addEventListener('click', ()=>{
    const arr = Array.from(listEl.children).map(li=> li.querySelector('.text').textContent);
    const csv = arr.map(r=> `"${r.replace(/"/g,'""')}"`).join('\n');
    download('lista.csv', csv, 'text/csv');
  });

})();

/* ===================== NOVAS FUNCIONALIDADES: ABRIR .ODS ===================== */
(function(){
  const fileInput = document.getElementById('ods-file-input');
  const openBtn = document.getElementById('ods-open-btn');
  const status = document.getElementById('ods-status');
  const preview = document.getElementById('ods-preview');
  const exportCsvBtn = document.getElementById('ods-export-csv');
  const exportXlsxBtn = document.getElementById('ods-export-xlsx');

  let currentWorkbook = null;
  let currentSheetName = null;

  function setStatus(s){ status.textContent = s; }

  function renderPreview(data){
    // data is array of arrays
    if(!Array.isArray(data) || data.length === 0){
      preview.innerHTML = '<div class="small-muted">Planilha vazia.</div>';
      return;
    }
    const maxRows = 50;
    const rows = data.slice(0, maxRows);
    const table = document.createElement('table');
    table.className = 'ods-table';
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    const first = rows[0];
    const colCount = Math.max(...rows.map(r=> r.length ));
    for(let c=0;c<colCount;c++){
      const th = document.createElement('th');
      th.textContent = rows[0][c] !== undefined ? rows[0][c] : '';
      trh.appendChild(th);
    }
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    for(let r=1;r<rows.length;r++){
      const tr = document.createElement('tr');
      for(let c=0;c<colCount;c++){
        const td = document.createElement('td');
        td.textContent = rows[r][c] !== undefined ? rows[r][c] : '';
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    preview.innerHTML = '';
    preview.appendChild(table);
    if(data.length > maxRows){
      const more = document.createElement('div');
      more.className = 'small-muted';
      more.style.marginTop = '6px';
      more.textContent = `Mostrando ${maxRows} primeiras linhas de ${data.length}.`;
      preview.appendChild(more);
    }
  }

  function handleFile(file){
    if(!file) return;
    setStatus('Carregando arquivo...');
    const reader = new FileReader();
    reader.onload = function(ev){
      try{
        const data = ev.target.result;
        const wb = XLSX.read(data, {type:'array'});
        currentWorkbook = wb;
        currentSheetName = wb.SheetNames[0];
        const ws = wb.Sheets[currentSheetName];
        const arr = XLSX.utils.sheet_to_json(ws, {header:1});
        setStatus(`Arquivo: ${file.name} — planilha: ${currentSheetName} — ${arr.length} linhas`);
        renderPreview(arr);
      }catch(err){
        console.error(err);
        setStatus('Erro ao ler arquivo. Verifique se é um .ods/.xlsx válido.');
        preview.innerHTML = '';
      }
    };
    reader.onerror = function(){ setStatus('Erro ao ler o arquivo.'); };
    reader.readAsArrayBuffer(file);
  }

  openBtn.addEventListener('click', ()=>{
    const f = fileInput.files && fileInput.files[0];
    if(!f){ alert('Selecione um arquivo .ods/.xlsx primeiro.'); return; }
    handleFile(f);
  });

  fileInput.addEventListener('change', ()=>{
    // auto abrir ao selecionar
    const f = fileInput.files && fileInput.files[0];
    if(f) handleFile(f);
  });

  exportCsvBtn.addEventListener('click', ()=>{
    if(!currentWorkbook) { alert('Nenhum arquivo carregado.'); return; }
    const ws = currentWorkbook.Sheets[currentSheetName];
    const csv = XLSX.utils.sheet_to_csv(ws);
    const fname = (currentSheetName || 'planilha') + '.csv';
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  exportXlsxBtn.addEventListener('click', ()=>{
    if(!currentWorkbook) { alert('Nenhum arquivo carregado.'); return; }
    try{
      const wbout = XLSX.write(currentWorkbook, {bookType:'xlsx', type:'array'});
      const blob = new Blob([wbout], {type:'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'export.xlsx'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }catch(err){
      console.error(err);
      alert('Erro ao exportar XLSX.');
    }
  });

})();

</script>
</body>
</html>
